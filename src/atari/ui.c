#include <stdint.h>
#include <stdio.h>
#include <string.h>
#include <atari.h>
// #include <conio.h>
#include <peekpoke.h>
#include <sys/types.h>
#include "api.h"
#include "util.h"
#include "globals.h"
#include "logo.c"
#include "font.h"
#include "ui.h"


#define CH_NEWLINE 0x9B
// #define DISPLAY_LIST   0x0600              // Memory address to store DISPLAY_LIST.  0x0600 is the first address available for user space memory (1)
// #define PMG_MEMORY     0x2000
// #define DISPLAY_MEMORY 0x7400
#define PMBASE 0xD407

uint8_t row = 0;
uint8_t col = 0;
unsigned char *cursor_ptr = scr_mem;
unsigned char *font_ptr = 0;


// const unsigned char logoData[640] = {
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7D, 0x5F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFD, 0xAA, 0x95, 0x5F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEA, 0xAB, 0xEF, 0xFE, 0xFF, 0xBE, 0xFF, 0xBD, 0x9F, 0x7F, 0xEF, 0xFF, 0xEF, 0xFF, 0xBF, 0xEF, 0xFF, 0xEF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0xFF, 0xEF, 0xFE, 0xFF, 0xBE, 0xFF, 0xBF, 0xBF, 0x7F, 0xEB, 0xFF, 0xEF, 0xFF, 0xBF, 0xEF, 0xFF, 0xEF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0xFF, 0xEF, 0xFE, 0xFF, 0xBE, 0xFC, 0x3D, 0x9D, 0x5F, 0xEE, 0xFF, 0xEF, 0xFE, 0xEF, 0xFB, 0xFF, 0xBF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0xFF, 0xEF, 0xFE, 0xFF, 0xBE, 0xD0, 0x05, 0xAA, 0x95, 0xEE, 0xFF, 0xEF, 0xFE, 0xEF, 0xFB, 0xFF, 0xBF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0xFF, 0xEF, 0xFE, 0xFF, 0xBE, 0xF0, 0x0D, 0x5F, 0x9F, 0xEF, 0xBF, 0xEF, 0xFB, 0xFB, 0xFE, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEA, 0xAB, 0xEF, 0xFE, 0xFF, 0xBE, 0xFC, 0x3F, 0x7F, 0xBF, 0xEF, 0xEF, 0xEF, 0xFB, 0xFB, 0xFE, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0xFF, 0xEF, 0xFE, 0xFF, 0xBE, 0xFF, 0x7F, 0x7F, 0x0F, 0xEF, 0xFB, 0xEF, 0xFB, 0xFB, 0xFE, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0xFF, 0xEF, 0xFE, 0xFF, 0xBE, 0xF5, 0x55, 0x54, 0x01, 0xEF, 0xFE, 0xEF, 0xEA, 0xAA, 0xFF, 0xBB, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0xFF, 0xEF, 0xFE, 0xFF, 0xBE, 0xFF, 0x7F, 0x7C, 0x03, 0xEF, 0xFE, 0xEF, 0xEF, 0xFE, 0xFF, 0xBB, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0xFF, 0xFB, 0xFB, 0xFF, 0xBE, 0xFF, 0xFF, 0x7F, 0x0F, 0xEF, 0xFF, 0xAF, 0xBF, 0xFF, 0xBF, 0xEF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0xFF, 0xFE, 0xAF, 0xEA, 0xFE, 0xFF, 0xFD, 0x55, 0x7F, 0xEF, 0xFF, 0xEF, 0xBF, 0xFF, 0xBF, 0xEF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
//   0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF
// };

const unsigned char logoData[640] = {
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 65, 80, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 170, 149, 80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 42, 168, 32, 2, 0, 130, 0, 129, 144, 64, 32, 0, 32, 0, 128, 32, 0, 32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 0, 32, 2, 0, 130, 0, 128, 128, 64, 40, 0, 32, 0, 128, 32, 0, 32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 0, 32, 2, 0, 130, 3, 193, 145, 80, 34, 0, 32, 2, 32, 8, 0, 128, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 0, 32, 2, 0, 130, 31, 245, 170, 149, 34, 0, 32, 2, 32, 8, 0, 128, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 0, 32, 2, 0, 130, 15, 241, 80, 144, 32, 128, 32, 8, 8, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 42, 168, 32, 2, 0, 130, 3, 192, 64, 128, 32, 32, 32, 8, 8, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 0, 32, 2, 0, 130, 0, 64, 64, 240, 32, 8, 32, 8, 8, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 0, 32, 2, 0, 130, 5, 85, 87, 253, 32, 2, 32, 42, 170, 0, 136, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 0, 32, 2, 0, 130, 0, 64, 67, 252, 32, 2, 32, 32, 2, 0, 136, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 0, 8, 8, 0, 130, 0, 0, 64, 240, 32, 0, 160, 128, 0, 128, 32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 0, 2, 160, 42, 2, 0, 1, 85, 64, 32, 0, 32, 128, 0, 128, 32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

void default_dlist = {
    DL_BLK8, DL_BLK8, DL_BLK8,
    DL_LMS(DL_CHR40x8x1), scr_mem,
    DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1,
    DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1,
    DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1,
    DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1,
    DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1,
    DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1,
    DL_JVB, dlist_mem
};

void splash_dlist = {
    DL_BLK8, DL_BLK8, DL_BLK8,
    DL_LMS(DL_CHR40x8x1), scr_mem, // 1
    DL_DLI(DL_LMS(DL_MAP160x2x4)), &logoData,
    DL_MAP160x2x4, DL_MAP160x2x4, DL_MAP160x2x4, // 2
    DL_MAP160x2x4, DL_MAP160x2x4, DL_MAP160x2x4, DL_MAP160x2x4, // 3
    DL_DLI(DL_MAP160x2x4),
    DL_MAP160x2x4, DL_MAP160x2x4, DL_MAP160x2x4, // 4
    DL_MAP160x2x4, DL_MAP160x2x4, DL_MAP160x2x4,
    DL_DLI(DL_MAP160x2x4), // 5
    DL_LMS(DL_CHR40x8x1), scr_mem + 40, // 6
    DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1, // 10
    DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1, // 14
    DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1, // 18
    DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1, DL_CHR40x8x1, // 22
    DL_CHR40x8x1, DL_CHR40x8x1, // 24
    DL_JVB, dlist_mem
};

void dli_text(void);
void dli_logo_top(void);
void dli_logo_bottom(void);

void wait_for_vblank(void)
{
    asm("lda $14");
wvb:
    asm("cmp $14");
    asm("beq %g", wvb);
}

void start_dli(void)
{
  ANTIC.nmien = NMIEN_DLI | NMIEN_VBI;
}

void stop_dli(void)
{
  ANTIC.nmien = NMIEN_VBI;
}

void screen_clear(void)
{
  memset(scr_mem, 0, 40*24); // TODO: smarter size calculation
} 

void screen_gotoxy(uint8_t x, uint8_t y)
{
  col = x;
  row = y;
  cursor_ptr = scr_mem + 40 * row + col; // TODO: Dynamic max column
}

void screen_newline() {
  // TODO: wrap around to top? scroll? ignore?
  cursor_ptr += 40 - col; // TODO: Dynamic max column
  col = 0;
  row++;
}

void screen_putc(char c)
{
  col++;
  if (col > 39) // TODO: Dynamic max column
    screen_newline();
  if (c == CH_NEWLINE)
    screen_newline();
  else if (c < 32)
    POKE(cursor_ptr++, c+64);
  else if (c < 96)
    POKE(cursor_ptr++, c-32);
  else
    POKE(cursor_ptr++, c);
}

void screen_puts(char *s) {
  char c;
  while ((c = *s++) != '\0')
    screen_putc(c);
}

void screen_hr(uint8_t length) {
  screen_newline();
  memset(cursor_ptr, SCR_ICON_HLINE, length);
  screen_newline();
}

void screen_pm_draw_icon(uint8_t icon, uint8_t p, uint8_t y) {
  uint8_t *src = font_ptr + icon * 8;
  uint8_t *dst = pmg_mem + 0x200 + p * 128 + y;
  memcpy(dst, src, 8);
  // memcpy(pmg_mem + 40, font_ptr + 40, 24);
}

void screen_pm_clear_icon(uint8_t p, uint8_t y) {
  memset(pmg_mem + 0x200 + p * 128 + y, 0, 8);
}

void dli_text(void)
{
 	asm("pha");
  asm("lda #$02");  // dark grey
  asm("sta $D40A"); // WSYNC
  asm("sta $D018"); // COLOR2
  OS.vdslst = &dli_logo_top;
  asm("pla");
  asm("rti");
}

void dli_logo_top(void)
{
 	asm("pha");
  asm("lda #$96");  // blue
  asm("sta $D40A"); // WSYNC
  asm("sta $D018"); // COLOR2
  // asm("lda #$66");
  // asm("sta $D017"); //COLOR2
  OS.vdslst = &dli_logo_bottom;
  asm("pla");
  asm("rti");
}

void dli_logo_bottom(void)
{
 	asm("pha");
  asm("lda #$36");  // red
  asm("sta $D40A"); // WSYNC
  asm("sta $D018"); //COLOR2
  OS.vdslst = &dli_text;
  asm("pla");
  asm("rti");
}

void set_dlist_default(void)
{
  memcpy((void *)dlist_mem, &default_dlist, sizeof(default_dlist));
}

void set_dlist_splash(void)
{
  memcpy((void *)dlist_mem, &splash_dlist, sizeof(splash_dlist));
}

void init_pmg(void) {
  ANTIC.pmbase = (uint16_t)pmg_mem >> 8;

  OS.pcolr0 = 0x96; // blue
  OS.pcolr1 = 0x36; // red

  GTIA_WRITE.hposp0 = 60;
  GTIA_WRITE.hposp1 = 120;

  // enable players
  GTIA_WRITE.gractl = 3;

  // enable single line PMG
  // OS.sdmctl = 62;
  OS.sdmctl = 46;

  // Normal
  OS.gprior = 1;
  // OS.gprior = 1 + 32;

  bzero(pmg_mem, 2048);
}

void ui_init(void)
{
  init_pmg();

  patch_font();
  font_ptr = PEEK(756) << 8;

  bzero(scr_mem, 40*25);

  set_dlist_default();
  OS.sdlst = (void *)dlist_mem;

  OS.color4 = 0x02;
  OS.color0 = 0x04;
  OS.color1 = 0x0E;
  OS.color2 = 0x02;
}

void ui_screen_splash() {
  unsigned char prevVal = 0;

  set_dlist_splash();

  // screen_clear();
  // save previous val of 0x22F
  // prevVal = *(unsigned char*)0x22F;
  // // shut off ANTIC
  // *(unsigned char*)0X22F = 0;

  // // set the dlist screen
  // memcpy((void *)DISPLAY_LIST, &splash_dlist, sizeof(splash_dlist));
  OS.vdslst = &dli_logo_top;

  // // restore ANTIC
  // *(unsigned char*)0x22F = prevVal;

  wait_for_vblank();
  start_dli();

  screen_gotoxy(0, 2);
  screen_putc(CH_ICON_WALK);
  screen_putc(CH_ICON_CAR);
  screen_putc(CH_ICON_BIKE);
  screen_putc(CH_ICON_BUS);
  screen_hr(40);
  screen_putc(CH_ICON_RAIL);
  screen_putc(CH_ICON_BOAT);
  screen_putc(CH_ICON_MERGE);
  screen_putc(CH_ICON_EXIT);
  screen_hr(40);
  screen_putc(CH_ICON_PLANE);
  screen_putc(CH_ICON_SKATEBOARD);

  screen_pm_draw_icon(SCR_ICON_PIN, 0, 40);
  screen_pm_draw_icon(SCR_ICON_CAR, 1, 80);
}

void ui_screen_settings() {
  screen_clear();
  set_dlist_default();

  screen_puts("Settings\nheyo");

}

void ui_screen_destination() {
  screen_clear();
  // show_logo();
  printf("DESTINATION\n\n");
}

void ui_screen_origin() {
  screen_clear();
  printf("STARTING POINT\n\n");
}

void ui_screen_route_options(struct RouteOptions *options) {
  // char input[80];
  // char c;

  screen_clear();
  printf("ROUTE OPTIONS\n");

  printf("\nMode (%s): ", options->mode);
  // readline(&input);
  // if (input[0] != '\0') {
  //   strcpy(options->mode, input);
  // }
}

void ui_screen_routing() {
  screen_clear();
  printf("ROUTING...\n");
}

void ui_screen_directions() {
  uint8_t i;
  screen_clear();
  printf("From: %s\n", fromLoc.desc);
  printf("To: %s\n", toLoc.desc);
  printf("%s | %s\n\n", directions.duration, directions.distance);

  for (i = 0; i < directions.num_steps; i++) {
    if (i > 0) {
      // chline(40);
    }
    printf("%s\n", directions.steps[i]->instructions);
  }
}
